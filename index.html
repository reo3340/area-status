<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>區域進度展示</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h2>區域進度展示</h2>
    <div class="map-container" id="mapContainer">
        <object data="./CTC_ELE.svg" type="image/svg+xml" id="map-svg"></object>
        <svg class="overlay-svg" id="overlaySvg" preserveAspectRatio="xMidYMid meet">
            <g class="interactive-areas"></g>
        </svg>
        <div class="tooltip" id="tooltip"></div>
    </div>
    <div class="control-panel">
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">-</button>
            <button class="zoom-btn" onclick="resetZoom()">重設</button>
        </div>
        <div class="mask-controls">
            <button class="mask-btn" onclick="toggleMaskMode()" id="maskBtn">新增遮罩</button>
            <button class="mask-btn" onclick="clearMasks()">清除遮罩</button>
        </div>
    </div>
    <div id="loading">載入中...</div>

    <script>
        let currentScale = 1.0;
        let isDrawingMask = false;
        let startPoint = null;
        
        const mapContainer = document.getElementById('mapContainer');
        const mapSvg = document.getElementById('map-svg');
        const overlaySvg = document.getElementById('overlaySvg');
        const interactiveAreas = overlaySvg.querySelector('.interactive-areas');
        const maskBtn = document.getElementById('maskBtn');

        // 修正 SVG 的寬高比例
        mapSvg.addEventListener('load', function() {
            const svgDoc = mapSvg.contentDocument;
            if (svgDoc) {
                const svgElement = svgDoc.querySelector('svg');
                if (svgElement) {
                    const viewBox = svgElement.getAttribute('viewBox');
                    if (viewBox) {
                        overlaySvg.setAttribute('viewBox', viewBox);
                    }
                    // 設置相同的寬高比
                    const width = svgElement.getAttribute('width');
                    const height = svgElement.getAttribute('height');
                    if (width && height) {
                        overlaySvg.setAttribute('width', width);
                        overlaySvg.setAttribute('height', height);
                    }
                }
            }
        });

        function toggleMaskMode() {
            isDrawingMask = !isDrawingMask;
            maskBtn.textContent = isDrawingMask ? '完成繪製' : '新增遮罩';
            document.body.style.cursor = isDrawingMask ? 'crosshair' : 'default';
            
            if (isDrawingMask) {
                mapContainer.addEventListener('mousedown', startDrawing);
                mapContainer.addEventListener('mousemove', drawMask);
                mapContainer.addEventListener('mouseup', endDrawing);
            } else {
                mapContainer.removeEventListener('mousedown', startDrawing);
                mapContainer.removeEventListener('mousemove', drawMask);
                mapContainer.removeEventListener('mouseup', endDrawing);
                
                // 清除任何臨時遮罩
                const tempMask = document.getElementById('tempMask');
                if (tempMask) tempMask.remove();
            }
        }

        function getScaledPoint(e) {
            const rect = overlaySvg.getBoundingClientRect();
            const point = overlaySvg.createSVGPoint();
            
            point.x = e.clientX - rect.left;
            point.y = e.clientY - rect.top;
            
            // 創建 SVG 變換矩陣
            const matrix = overlaySvg.getScreenCTM().inverse();
            return point.matrixTransform(matrix);
        }

        function startDrawing(e) {
            if (!isDrawingMask) return;
            e.preventDefault();
            
            startPoint = getScaledPoint(e);
            
            // 創建臨時遮罩
            const tempMask = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tempMask.setAttribute("id", "tempMask");
            tempMask.setAttribute("class", "area");
            interactiveAreas.appendChild(tempMask);
        }

        function drawMask(e) {
            if (!isDrawingMask || !startPoint) return;
            e.preventDefault();
            
            const currentPoint = getScaledPoint(e);
            const tempMask = document.getElementById('tempMask');
            
            if (tempMask) {
                const path = `M${startPoint.x},${startPoint.y} L${currentPoint.x},${startPoint.y} L${currentPoint.x},${currentPoint.y} L${startPoint.x},${currentPoint.y} Z`;
                tempMask.setAttribute("d", path);
            }
        }

        function endDrawing(e) {
            if (!isDrawingMask || !startPoint) return;
            e.preventDefault();
            
            const endPoint = getScaledPoint(e);

            // 如果拖曳距離太小，不創建遮罩
            const minDistance = 5;
            if (Math.abs(endPoint.x - startPoint.x) < minDistance || 
                Math.abs(endPoint.y - startPoint.y) < minDistance) {
                const tempMask = document.getElementById('tempMask');
                if (tempMask) tempMask.remove();
                startPoint = null;
                return;
            }

            // 創建最終的遮罩
            const mask = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const path = `M${startPoint.x},${startPoint.y} L${endPoint.x},${startPoint.y} L${endPoint.x},${endPoint.y} L${startPoint.x},${endPoint.y} Z`;
            
            mask.setAttribute("d", path);
            mask.setAttribute("class", "area");
            mask.setAttribute("id", "mask" + Date.now());
            mask.setAttribute("data-name", "遮罩區域");
            
            interactiveAreas.appendChild(mask);

            // 移除臨時遮罩
            const tempMask = document.getElementById('tempMask');
            if (tempMask) tempMask.remove();

            startPoint = null;
        }

        function clearMasks() {
            if (confirm('確定要清除所有遮罩嗎？')) {
                while (interactiveAreas.firstChild) {
                    interactiveAreas.removeChild(interactiveAreas.firstChild);
                }
            }
        }

        function updateZoom() {
            mapSvg.style.width = (100 * currentScale) + '%';
            mapSvg.style.height = (100 * currentScale) + '%';
            overlaySvg.style.width = (100 * currentScale) + '%';
            overlaySvg.style.height = (100 * currentScale) + '%';
        }

        function zoomIn() {
            currentScale *= 1.2;
            updateZoom();
        }

        function zoomOut() {
            currentScale /= 1.2;
            if (currentScale < 1) currentScale = 1;
            updateZoom();
        }

        function resetZoom() {
            currentScale = 1.0;
            updateZoom();
        }

        // 初始化
        updateZoom();
    </script>
</body>
</html>
