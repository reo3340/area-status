<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網路施工進度（唯讀）</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h2>網路施工進度</h2>
    <div class="main-container">
        <div class="map-container" id="mapContainer">
            <object data="./CTC_ELE.svg" type="image/svg+xml" id="map-svg"></object>
            <svg class="overlay-svg" id="overlaySvg">
                <!-- 可點擊區域 -->
                <g class="interactive-areas"></g>
                <!-- 遮罩區域 -->
                <g class="mask-areas equipment"></g>
                <g class="mask-areas electrical-box"></g>
            </svg>
            <div class="tooltip" id="tooltip"></div>
        </div>
        <div class="side-panel" id="sidePanel">
            <div class="area-list" id="equipmentList">
                <div class="area-list-header">
                    <h3>設備區域</h3>
                </div>
                <!-- 設備區域列表 -->
            </div>
            <div class="area-list" id="electricalBoxList">
                <div class="area-list-header">
                    <h3>電箱區域</h3>
                </div>
                <!-- 電箱區域列表 -->
            </div>
        </div>
    </div>
    <div id="loading">載入中...</div>

    <script>
        // 全域變數
        let currentScale = 1.7;
        let isPanning = false;
        let startPanPoint = null;
        
        // DOM 元素
        const mapContainer = document.getElementById('mapContainer');
        const mapSvg = document.getElementById('map-svg');
        const overlaySvg = document.getElementById('overlaySvg');
        const interactiveAreas = overlaySvg.querySelector('.interactive-areas');
        const equipmentList = document.getElementById('equipmentList');
        const electricalBoxList = document.getElementById('electricalBoxList');

        // 清除所有區域
        function clearAreas() {
            const existingAreas = document.querySelectorAll('.area');
            const existingMasks = document.querySelectorAll('.area-mask');
            const existingItems = document.querySelectorAll('.area-item');

            existingAreas.forEach(area => area.remove());
            existingMasks.forEach(mask => mask.remove());
            existingItems.forEach(item => item.remove());
        }

        // 修正 SVG 的寬高比例和縮放功能
        mapSvg.addEventListener('load', function() {
            const svgDoc = mapSvg.contentDocument;
            if (svgDoc) {
                const svgElement = svgDoc.querySelector('svg');
                if (svgElement) {
                    const viewBox = svgElement.getAttribute('viewBox');
                    if (viewBox) {
                        overlaySvg.setAttribute('viewBox', viewBox);
                    }

                    // 縮放功能
                    mapContainer.addEventListener('wheel', function(e) {
                        e.preventDefault();
                        const delta = e.deltaY;
                        const scaleChange = delta > 0 ? 0.9 : 1.1;
                        const newScale = currentScale * scaleChange;

                        if (newScale >= 0.5 && newScale <= 3) {
                            currentScale = newScale;
                            mapSvg.style.transform = `scale(${currentScale})`;
                            overlaySvg.style.transform = `scale(${currentScale})`;
                        }
                    });

                    // 使用滑鼠左鍵拖曳地圖
                    mapContainer.addEventListener('mousedown', function(e) {
                        if (e.button === 0) {
                            isPanning = true;
                            startPanPoint = { x: e.clientX, y: e.clientY };
                            mapContainer.style.cursor = 'grabbing';
                        }
                    });

                    mapContainer.addEventListener('mousemove', function(e) {
                        if (isPanning && startPanPoint) {
                            const dx = e.clientX - startPanPoint.x;
                            const dy = e.clientY - startPanPoint.y;
                            mapContainer.scrollLeft -= dx;
                            mapContainer.scrollTop -= dy;
                            startPanPoint = { x: e.clientX, y: e.clientY };
                        }
                    });

                    mapContainer.addEventListener('mouseup', function() {
                        if (isPanning) {
                            isPanning = false;
                            startPanPoint = null;
                            mapContainer.style.cursor = 'default';
                        }
                    });

                    // 設定初始縮放
                    mapSvg.style.transform = `scale(${currentScale})`;
                    overlaySvg.style.transform = `scale(${currentScale})`;
                    clearAreas(); // 先清除現有的區域
                    loadAreas(); // 在地圖載入後才載入區域
                }
            }
        });

        // 載入區域資料
        function loadAreas() {
            const savedAreas = localStorage.getItem('areas');
            if (!savedAreas) return;

            try {
                const areas = JSON.parse(savedAreas);
                areas.forEach(areaData => {
                    if (!areaData || !areaData.id || !areaData.name || !areaData.type || !areaData.pathD) return;

                    // 創建區域
                    const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    area.setAttribute('d', areaData.pathD);
                    area.setAttribute('class', 'area');
                    area.setAttribute('id', areaData.id);
                    area.setAttribute('title', areaData.name);

                    // 創建遮罩
                    const mask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    mask.setAttribute('d', areaData.pathD);
                    mask.setAttribute('class', `area-mask ${areaData.status}`);
                    mask.setAttribute('id', `mask-${areaData.id}`);

                    // 添加到 SVG
                    const maskGroup = overlaySvg.querySelector(`.mask-areas.${areaData.type}`);
                    const areaGroup = overlaySvg.querySelector('.interactive-areas');
                    if (maskGroup && areaGroup) {
                        areaGroup.appendChild(area);
                        maskGroup.appendChild(mask);

                        // 創建區域項目
                        const areaItem = document.createElement('div');
                        areaItem.classList.add('area-item');
                        areaItem.setAttribute('data-area-id', areaData.id);
                        areaItem.setAttribute('data-area-type', areaData.type);
                        areaItem.innerHTML = `
                            <div class="color-indicator ${areaData.status}"></div>
                            <span class="area-name">${areaData.name}</span>
                            <span class="status-text">${getStatusText(areaData.status)}</span>
                        `;

                        // 添加區域項目到清單
                        const targetList = areaData.type === 'equipment' ? equipmentList : electricalBoxList;
                        targetList.appendChild(areaItem);

                        // 添加懸停效果
                        area.addEventListener('mouseenter', function(e) {
                            showTooltip(e, areaData.name);
                        });

                        area.addEventListener('mouseleave', function() {
                            hideTooltip();
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading areas:', error);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'gray': '施工中',
                'blue': '配線完成',
                'green': '連線成功'
            };
            return statusMap[status] || status;
        }

        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
    </script>
</body>
</html>
