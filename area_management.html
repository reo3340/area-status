<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網路施工進度</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h2>網路施工進度</h2>
    <div class="main-container" style="display: grid; grid-template-columns: 1fr auto;">
        <div class="map-container" id="mapContainer">
            <object data="./CTC_ELE.svg" type="image/svg+xml" id="map-svg"></object>
            <svg class="overlay-svg" id="overlaySvg">
                <g id="allContent">
                    <!-- 可點擊區域 -->
                    <g class="interactive-areas"></g>
                    <!-- 遮罩區域 -->
                    <g class="mask-areas equipment"></g>
                    <g class="mask-areas electrical-box"></g>
                    <!-- 繪製中的區域 -->
                    <path id="drawingArea" class="drawing" style="display: none;"/>
                </g>
            </svg>
            <div class="tooltip" id="tooltip"></div>

        </div>
        <div class="side-panel" id="sidePanel">
            <div class="area-list" id="equipmentList">
                <div class="area-list-header">
                    <h3>設備區域</h3>
                    <button class="mask-btn" onclick="toggleDrawMode('equipment', this)" id="equipmentBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        新增設備區域
                    </button>
                </div>
                <div class="area-list-content" id="equipmentListContent">
                    <!-- 區域按鈕會動態添加到這裡 -->
                </div>
            </div>
            <div class="area-list" id="electricalBoxList">
                <div class="area-list-header">
                    <h3>電箱區域</h3>
                    <button class="mask-btn" id="electricalBoxBtn" onclick="toggleDrawMode('electrical-box', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        新增電箱區域
                    </button>
                </div>
                <div class="area-list-content" id="electricalBoxListContent">
                    <!-- 區域按鈕會動態添加到這裡 -->
                </div>
            </div>
        </div>
    </div>
    <div id="loading">載入中...</div>

    <style>
        /* 側邊欄樣式 */
        .side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: calc(100vh - 100px);
            overflow: hidden;
            position: sticky;
            top: 16px;
            padding: 16px;
            box-sizing: border-box;
        }
        
        /* 區域列表樣式 */
        .area-list {
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 200px;
            max-height: calc(50% - 16px);
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        /* 區域列表標題 */
        .area-list-header {
            padding: 12px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0; /* 確保標題不會被壓縮 */
        }
        
        /* 區域列表內容區 */
        .area-list-content {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
            min-height: 100px;
            background: white;
            border-radius: 0 0 8px 8px;
        }
        
        /* 區域項目樣式 */
        .area-item {
            cursor: move;
            user-select: none;
            background: white;
            border: 1px solid #ddd;
            margin: 4px 0;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .status-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-circle.none {
            background: #999;
            border: none;
        }

        .status-circle.blue {
            background: #2196F3;
        }

        .status-circle.green {
            background: #4CAF50;
        }

        .area-item.dragging {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .area-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }

        /* 移除拖動圖示
        .area-item::before {
            content: '⋮⋮';
            padding: 0 8px;
            color: #999;
            cursor: move;
        }
        */

        .area-item:hover {
            background: #f8f8f8;
        }

        .drop-position {
            height: 2px;
            background-color: #2196F3;
            margin: 4px 0;
            transition: all 0.2s ease;
            pointer-events: none;
            position: relative;
        }

        .drop-position::before {
            content: '';
            position: absolute;
            left: 0;
            top: -4px;
            width: 100%;
            height: 10px;
            background: transparent;
        }

        .area-item.dragging {
            opacity: 0.5;
            background: #f5f5f5;
            border: 1px dashed #999;
        }

        #accessModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #accessModal .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
        }

        #accessModal input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #accessModal .modal-buttons {
            margin-top: 15px;
        }

        #accessModal .confirm-btn {
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #accessModal .confirm-btn:hover {
            background-color: #45a049;
        }
        
        /* 繪製工具樣式 */
        .drawing {
            fill: none;
            stroke: #ff0000;
            stroke-width: 0.5px;
            stroke-dasharray: 2,2;
            pointer-events: none;
        }
        
        /* 區域樣式 */
        .area {
            fill: transparent;
            stroke: #2196F3;
            stroke-width: 0.5px;
            cursor: pointer;
        }
        
        /* 遮罩樣式 */
        .area-mask {
            fill-opacity: 0.5;
            stroke: none;
            pointer-events: none;
        }
        
        .area-mask.gray { fill: #999; }
        .area-mask.blue { fill: #2196F3; }
        .area-mask.green { fill: #4CAF50; }
    </style>

    <!-- 訪問碼輸入對話框 -->
    <div class="modal" id="accessModal" style="display: none;">
        <div class="modal-content">
            <h3>輸入訪問碼</h3>
            <input type="password" id="accessInput" placeholder="請輸入訪問碼">
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="verifyAccess()">確定</button>
            </div>
        </div>
    </div>
    
    <!-- 命名對話框 -->
    <div class="modal" id="nameModal" style="display: none;">
        <div class="modal-content">
            <h3>命名區域</h3>
            <input type="text" id="areaName" placeholder="請輸入區域名稱">
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="confirmAreaName()">確定</button>
                <button class="cancel-btn" onclick="resetDrawingState()">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 修復區域項目添加問題的函數
        function fixAreaItemsPlacement() {
            // 獲取所有區域項目
            const equipmentItems = document.querySelectorAll('#equipmentList > .area-item');
            const electricalBoxItems = document.querySelectorAll('#electricalBoxList > .area-item');
            
            // 獲取內容區
            const equipmentContent = document.getElementById('equipmentListContent');
            const electricalBoxContent = document.getElementById('electricalBoxListContent');
            
            // 移動設備區域項目到正確的內容區
            if (equipmentContent) {
                equipmentItems.forEach(item => {
                    equipmentContent.appendChild(item);
                });
            }
            
            // 移動電箱區域項目到正確的內容區
            if (electricalBoxContent) {
                electricalBoxItems.forEach(item => {
                    electricalBoxContent.appendChild(item);
                });
            }
        }
        
        // 在確認區域命名後添加區域項目到內容區並自動滾動到視圖中
        function addAreaItemToContent(areaItem, areaType) {
            const contentId = areaType === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
            const contentArea = document.getElementById(contentId);
            if (contentArea) {
                contentArea.appendChild(areaItem);
                // 自動滾動到新添加的區域項目
                areaItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                return true;
            }
            return false;
        }
        
        // 觀察 DOM 變化，確保新添加的區域項目可見
        function setupScrollIntoViewObserver() {
            // 觀察設備區域內容區
            const equipmentContent = document.getElementById('equipmentListContent');
            if (equipmentContent) {
                const equipmentObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // 有新的區域項目被添加
                            const lastAddedNode = mutation.addedNodes[mutation.addedNodes.length - 1];
                            if (lastAddedNode.classList && lastAddedNode.classList.contains('area-item')) {
                                // 延遲一下再滾動，確保 DOM 已經更新
                                setTimeout(() => {
                                    lastAddedNode.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 100);
                            }
                        }
                    });
                });
                equipmentObserver.observe(equipmentContent, { childList: true });
            }
            
            // 觀察電箱區域內容區
            const electricalBoxContent = document.getElementById('electricalBoxListContent');
            if (electricalBoxContent) {
                const electricalBoxObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // 有新的區域項目被添加
                            const lastAddedNode = mutation.addedNodes[mutation.addedNodes.length - 1];
                            if (lastAddedNode.classList && lastAddedNode.classList.contains('area-item')) {
                                // 延遲一下再滾動，確保 DOM 已經更新
                                setTimeout(() => {
                                    lastAddedNode.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 100);
                            }
                        }
                    });
                });
                electricalBoxObserver.observe(electricalBoxContent, { childList: true });
            }
        }
        
        // 在頁面載入完成後執行修復函數和設置觀察器
        window.addEventListener('load', function() {
            fixAreaItemsPlacement();
            setupScrollIntoViewObserver();
        });
        
        // 全域變數
        let isAuthenticated = false;
        const correctToken = '4521';

        // 顯示訪問碼輸入對話框
        function showAccessModal() {
            document.getElementById('accessModal').style.display = 'flex';
            document.getElementById('accessInput').focus();
        }

        // 隱藏主要內容
        function hideMainContent() {
            document.querySelector('.main-container').style.visibility = 'hidden';
            document.getElementById('nameModal').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }

        // 顯示主要內容
        function showMainContent() {
            const mainContainer = document.querySelector('.main-container');
            mainContainer.style.visibility = 'visible';
            mainContainer.style.display = 'grid';
            document.getElementById('accessModal').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }

        // 驗證訪問碼
        function verifyAccess() {
            const accessInput = document.getElementById('accessInput');
            if (accessInput.value === correctToken) {
                isAuthenticated = true;
                showMainContent();
                initializeApp(); // 初始化應用
            } else {
                alert('訪問碼不正確');
                accessInput.value = '';
                accessInput.focus();
            }
        }

        // 監聽 Enter 鍵
        document.getElementById('accessInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                verifyAccess();
            }
        });

        // 初始化應用
        function initializeApp() {
            // 將原本的初始化代碼移到這裡
            resetDrawingState();
            initDragAndDrop();
            loadAreas(); // 載入儲存的區域
            initializeMap().then(() => {
                console.log('地圖初始化完成');
            }).catch(error => {
                console.error('地圖初始化失敗:', error);
            });
        }

        // 初始設置
        hideMainContent();
        const mapContainer = document.getElementById('mapContainer');
        const mapSvg = document.getElementById('map-svg');
        const overlaySvg = document.getElementById('overlaySvg');
        const interactiveAreas = overlaySvg.querySelector('.interactive-areas');
        const drawingArea = document.getElementById('drawingArea');
        const equipmentBtn = document.getElementById('equipmentBtn');
        const electricalBoxBtn = document.getElementById('electricalBoxBtn');
        const nameModal = document.getElementById('nameModal');
        const areaNameInput = document.getElementById('areaName');
        const equipmentList = document.getElementById('equipmentList');
        const electricalBoxList = document.getElementById('electricalBoxList');

        // 重置所有狀態
        function resetDrawingState() {
            // 重置繪製模式
            isDrawing = false;
            points = [];
            currentDrawingData = null;
            
            // 重置按鈕狀態
            document.querySelectorAll('.mask-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent = btn.textContent.replace('取消', '新增');
            });
            
            // 重置游標
            overlaySvg.style.cursor = 'default';
            
            // 重置繪製區域
            tempArea = document.getElementById('drawingArea');
            if (tempArea) {
                tempArea.style.display = 'none';
                tempArea.setAttribute('d', '');
            }
            
            // 重置當前區域類型
            currentAreaType = null;
            drawingButton = null;
            
            // 隱藏命名對話框
            const nameModal = document.getElementById('nameModal');
            if (nameModal) {
                nameModal.style.display = 'none';
            }
        }

        // 修正 SVG 的寬高比例和縮放功能
        // 等待 SVG 和所有元素載入完成
        function initializeMap() {
            return new Promise((resolve, reject) => {
                mapSvg.addEventListener('load', function() {
                    const svgDoc = mapSvg.contentDocument;
                    if (svgDoc) {
                        const svgElement = svgDoc.querySelector('svg');
                        if (svgElement) {
                            // 設置寬高比例
                            const viewBox = svgElement.getAttribute('viewBox');
                            if (viewBox) {
                                overlaySvg.setAttribute('viewBox', viewBox);
                            }

                            // 設置大小
                            const containerWidth = mapContainer.clientWidth;
                            const containerHeight = containerWidth / (svgElement.getAttribute('viewBox').split(' ')[2] / svgElement.getAttribute('viewBox').split(' ')[3]);
                            overlaySvg.style.width = `${containerWidth}px`;
                            overlaySvg.style.height = `${containerHeight}px`;

                            // 設置觀察範圍
                            overlaySvg.setAttribute('viewBox', viewBox);

                            // 設置滑鼠事件
                            overlaySvg.addEventListener('mousedown', startDrawing);
                            overlaySvg.addEventListener('mousemove', draw);
                            overlaySvg.addEventListener('mouseup', stopDrawing);
                            overlaySvg.addEventListener('mouseleave', stopDrawing);

                            // 載入區域資料
                            clearAreas(); // 先清除現有的區域
                            loadAreas(); // 在地圖載入後才載入區域

                            // 在初始化時儲存原始 viewBox
                            const initialViewBox = overlaySvg.getAttribute('viewBox');
                            if (initialViewBox) {
                                originalViewBox = initialViewBox.split(' ').map(Number);
                            }
                            
                            // 禁用滾輪縮放，只防止預設的滾動行為
                            mapContainer.addEventListener('wheel', function(e) {
                                e.preventDefault();
                            });

                            // 移除平移功能
                            // 設置滑鼠樣式
                            mapContainer.style.cursor = 'default';

                            resolve();
                        } else {
                            reject('SVG element not found');
                        }
                    } else {
                        reject('SVG document not found');
                    }
                });
            });
        }

        // 開始繪製
        function startDrawing(e) {
            if (!currentAreaType) return;
            
            isDrawing = true;
            points = [];
            
            // 確保繪製區域存在
            tempArea = document.getElementById('drawingArea');
            if (!tempArea) {
                // 如果不存在，則創建一個
                tempArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempArea.setAttribute('id', 'drawingArea');
                tempArea.classList.add('drawing');
                document.querySelector('.interactive-areas').appendChild(tempArea);
            }
            
            tempArea.style.display = 'block';
            tempArea.setAttribute('d', '');
            
            // 記錄起始點
            const point = getMousePosition(e);
            points.push(point);
            
            // 設置起始路徑
            tempArea.setAttribute('d', `M ${point.x} ${point.y}`);
        }

        // 繪製中
        function draw(e) {
            if (isDrawing) {
                // 確保繪製區域存在
                tempArea = tempArea || document.getElementById('drawingArea');
                if (!tempArea) {
                    tempArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    tempArea.setAttribute('id', 'drawingArea');
                    tempArea.classList.add('drawing');
                    document.querySelector('.interactive-areas').appendChild(tempArea);
                }

                const point = getMousePosition(e);
                
                // 如果有起始點，則創建矩形
                if (points.length > 0) {
                    const startPoint = points[0];
                    // 生成矩形路徑
                    const rectanglePath = `M ${startPoint.x} ${startPoint.y} L ${point.x} ${startPoint.y} L ${point.x} ${point.y} L ${startPoint.x} ${point.y} Z`;
                    tempArea.setAttribute('d', rectanglePath);
                }
            }
        }

        // 獲取滑鼠坐標
        function getMousePosition(e) {
            try {
                // 使用 SVG 的內建方法轉換坐標
                const point = overlaySvg.createSVGPoint();
                point.x = e.clientX;
                point.y = e.clientY;
                
                // 獲取當前的變換矩陣並應用反變換
                const CTM = overlaySvg.getScreenCTM();
                if (!CTM) return null;
                
                // 應用反變換得到 SVG 坐標系中的坐標
                const transformedPoint = point.matrixTransform(CTM.inverse());
                
                console.log(`Mouse position: (${transformedPoint.x}, ${transformedPoint.y})`);
                return transformedPoint;
            } catch (error) {
                console.error('Error getting mouse position:', error);
                return null;
            }
        }
        
        // 同步更新遮罩位置
        function syncMasks() {
            console.log('同步更新遮罩位置...');
            const areas = document.querySelectorAll('.area');
            console.log(`找到 ${areas.length} 個區域需要同步`);
            areas.forEach(area => {
                const areaId = area.getAttribute('id');
                if (areaId) {
                    const mask = document.getElementById(`mask-${areaId}`);
                    if (mask) {
                        const areaPath = area.getAttribute('d');
                        console.log(`同步區域 ${areaId} 的遮罩:`);
                        console.log(`區域路徑: ${areaPath}`);
                        mask.setAttribute('d', areaPath);
                        console.log(`遮罩路徑設置為: ${mask.getAttribute('d')}`);
                    } else {
                        console.warn(`找不到區域 ${areaId} 的遮罩`);
                    }
                }
            });
        }
        
        // 同步所有遮罩的位置
        function syncMasks() {
            console.log('Syncing masks...');
            // 獲取所有區域元素
            const areas = document.querySelectorAll('.area');
            console.log(`Found ${areas.length} areas to sync`);
            
            // 遍歷每個區域元素
            areas.forEach(area => {
                const areaId = area.getAttribute('id');
                if (areaId) {
                    // 獲取對應的遮罩元素
                    const mask = document.getElementById(`mask-${areaId}`);
                    if (mask) {
                        const areaPath = area.getAttribute('d');
                        console.log(`Syncing mask for area ${areaId}:`);
                        console.log(`Area path: ${areaPath}`);
                        
                        // 確保遮罩使用與區域相同的路徑
                        mask.setAttribute('d', areaPath);
                        
                        console.log(`Mask path set to: ${mask.getAttribute('d')}`);
                    } else {
                        console.warn(`Mask not found for area ${areaId}`);
                    }
                }
            });
        }
        // 生成矩形路徑數據
        function generatePathData(startPoint, endPoint) {
            if (!startPoint || !endPoint) return '';
            
            if (isNaN(startPoint.x) || isNaN(startPoint.y) || isNaN(endPoint.x) || isNaN(endPoint.y)) return '';
            
            // 生成矩形路徑
            return `M ${startPoint.x} ${startPoint.y} L ${endPoint.x} ${startPoint.y} L ${endPoint.x} ${endPoint.y} L ${startPoint.x} ${endPoint.y} Z`;
        }

        // 結束繪製
        function stopDrawing(e) {
            if (isDrawing) {
                isDrawing = false;
                
                if (points.length >= 1) { // 只需要起始點
                    const startPoint = points[0];
                    // 使用當前滑鼠位置作為結束點，而不是最後一個點
                    const endPoint = e ? getMousePosition(e) : points[points.length - 1];
                    
                    // 確保矩形有足夠的大小
                    const width = Math.abs(endPoint.x - startPoint.x);
                    const height = Math.abs(endPoint.y - startPoint.y);
                    
                    if (width < 2 || height < 2) {
                        // 矩形太小，取消繪製
                        resetDrawingState();
                        return;
                    }
                    
                    // 使用矩形路徑
                    const rectanglePath = generatePathData(startPoint, endPoint);
                    tempArea.setAttribute('d', rectanglePath);
                    
                    // 儲存當前繪製的資訊，以便命名後使用
                    currentDrawingData = {
                        path: rectanglePath,
                        type: currentAreaType
                    };
                    
                    // 顯示命名對話框
                    showNameModal();
                    console.log('顯示命名對話框');
                }
            }
        }
        
        // 顯示命名對話框
        function showNameModal() {
            const nameModal = document.getElementById('nameModal');
            if (nameModal) {
                nameModal.style.display = 'flex';
                document.getElementById('areaName').value = '';
                document.getElementById('areaName').focus();
            }
        }
        
        // 確認區域命名
        function confirmAreaName() {
            const name = document.getElementById('areaName').value.trim() || `區域 ${Date.now()}`;
            const areaId = Date.now().toString();
            
            // 創建區域
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('id', areaId);
            area.setAttribute('d', currentDrawingData.path);
            area.setAttribute('class', 'area');
            area.setAttribute('data-area-type', currentDrawingData.type);
            interactiveAreas.appendChild(area);

            // 創建遮罩
            const mask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mask.setAttribute('id', `mask-${areaId}`);
            mask.setAttribute('d', currentDrawingData.path);
            mask.setAttribute('class', `area-mask gray`); // 預設為灰色
            const maskGroup = overlaySvg.querySelector(`.mask-areas.${currentAreaType}`);
            if (maskGroup) {
                maskGroup.appendChild(mask);
            }

            // 創建列表項目
            const areaItem = document.createElement('div');
            areaItem.className = 'area-item';
            areaItem.setAttribute('data-area-id', areaId);
            areaItem.setAttribute('data-area-type', currentAreaType);
            areaItem.setAttribute('draggable', 'true');
            areaItem.innerHTML = `
                <span class="color-indicator none"></span>
                <span class="area-name" title="${name}">${name}</span>
                <select class="mask-select" onchange="toggleAreaMask(document.getElementById('${areaId}'), this.value)">
                    <option value="none">未施工</option>
                    <option value="blue">配線完成</option>
                    <option value="green">連線成功</option>
                </select>
                <button class="action-btn delete-btn" onclick="deleteArea('${areaId}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;

            // 添加區域項目到清單
            const contentId = currentAreaType === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
            const contentArea = document.getElementById(contentId);
            if (contentArea) {
                contentArea.appendChild(areaItem);
            }
            
            // 確保新添加的區域項目可見
            setTimeout(() => {
                // 獲取對應的內容區
                const contentId = currentAreaType === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
                const contentArea = document.getElementById(contentId);
                if (contentArea) {
                    contentArea.scrollTop = contentArea.scrollHeight;
                }
            }, 100);

            // 添加事件監聽器
            area.addEventListener('click', function(e) {
                if (!isDrawing) {
                    toggleAreaMask(this);
                }
            });

            // 保存變更
            saveAreas();

            // 重新綁定拖放事件
            bindDragEventsToItems();

            // 重置狀態
            resetDrawingState();
            nameModal.style.display = 'none';
            areaNameInput.value = '';
            if (tempArea) {
                tempArea.remove();
                tempArea = null;
            }
        }

        // 載入區域資料
        function loadAreas() {
            const savedAreas = localStorage.getItem('areas');
            if (!savedAreas) return;

            try {
                const areas = JSON.parse(savedAreas);
                areas.forEach(areaData => {
                    const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    area.setAttribute('id', areaData.id);
                    area.setAttribute('class', 'area');
                    area.setAttribute('d', areaData.path);
                    area.setAttribute('data-name', areaData.name);
                    area.setAttribute('data-area-type', areaData.areaType);
                    interactiveAreas.appendChild(area);

                    // 創建區域按鈕
                    const areaItem = document.createElement('div');
                    areaItem.classList.add('area-item');
                    areaItem.setAttribute('data-area-id', areaData.id);
                    areaItem.setAttribute('data-area-type', areaData.areaType);
                    areaItem.innerHTML = `
                        <span class="color-indicator ${areaData.color}"></span>
                        <span class="area-name" title="${areaData.name}" onclick="editAreaName('${areaData.id}')">${areaData.name}</span>
                        <select class="mask-select" onchange="toggleAreaMask(document.getElementById('${areaData.id}'), this.value)">
                            <option value="gray" ${areaData.color === 'gray' ? 'selected' : ''}>施工中</option>
                            <option value="blue" ${areaData.color === 'blue' ? 'selected' : ''}>配線完成</option>
                            <option value="green" ${areaData.color === 'green' ? 'selected' : ''}>連線成功</option>
                        </select>
                        <button class="action-btn delete-btn" onclick="deleteArea('${areaData.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    `;

                    if (areaData.areaType === 'equipment') {
                        equipmentList.appendChild(areaItem);
                    } else {
                        electricalBoxList.appendChild(areaItem);
                    }

                    // 如果有選擇顏色，則創建遮罩
                    if (areaData.color && areaData.color !== 'none') {
                        const mask = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        mask.setAttribute('id', `mask-${areaData.id}`);
                        mask.setAttribute('d', areaData.path);
                        mask.setAttribute('class', `area-mask ${areaData.color}`);
                        const maskGroup = document.querySelector(`.mask-areas.${areaData.areaType}`);
                        if (maskGroup) {
                            maskGroup.appendChild(mask);
                        }
                    }

                    // 添加事件監聽器
                    area.addEventListener('contextmenu', function(e) {
                        e.preventDefault(); // 阻止默認右鍵選單
                        if (!isDrawing) {
                            startDragging(e, area);
                        }
                    });

                    area.addEventListener('mousemove', function(e) {
                        if (isDragging && selectedArea === area) {
                            dragArea(e);
                        }
                    });

                    area.addEventListener('mouseup', function(e) {
                        if (isDragging && selectedArea === area && e.button === 2) { // 只有右鍵才停止拖曳
                            stopDragging();
                        }
                    });

                    area.addEventListener('mouseleave', function() {
                        if (isDragging && selectedArea === area) {
                            stopDragging();
                        }
                    });


                });
            } catch (error) {
                console.error('Error loading areas:', error);
            }
        }

        // 初始化地圖
        initializeMap().catch(error => {
            console.error('Failed to initialize map:', error);
        });
        
        // 切換繪製模式
        function toggleDrawMode(areaType, button) {
            // 如果已經在繪製且點擊相同按鈕，則完成繪製
            if (isDrawing && currentAreaType === areaType) {
                resetDrawingState();
                return;
            }
            
            // 重置其他按鈕狀態
            document.querySelectorAll('.mask-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent = btn.textContent.replace('取消', '新增');
            });
            
            // 設定繪製模式
            isDrawing = false; // 確保初始狀態為 false
            points = []; // 清空點集合
            currentAreaType = areaType;
            drawingButton = button;
            button.classList.add('active');
            button.textContent = '取消繪製';
            overlaySvg.style.cursor = 'crosshair';
            
            // 重置繪製區域
            tempArea = document.getElementById('drawingArea');
            if (tempArea) {
                tempArea.style.display = 'none';
                tempArea.setAttribute('d', '');
            }
        }

        // 刪除區域時也要保存
        const originalDeleteArea = deleteArea;
        deleteArea = function(areaId) {
            // 刪除控制點
            const controlPoints = document.querySelector(`g[data-area-id="${areaId}"]`);
            if (controlPoints) controlPoints.remove();
            
            originalDeleteArea(areaId);
            saveAreas();
        };

        // 開始拖曳
        function startDragging(e, area) {
            if (e.button === 2) { // 只有右鍵才能拖曳避免與地圖拖曳衝突
                isDragging = true;
                selectedArea = area;
                dragStartPos = getMousePosition(e);
            }
        }

        // 拖曳區域
        function dragArea(e) {
            if (!isDragging || !selectedArea || e.buttons !== 2) return; // 確保右鍵按住

            const currentPos = getMousePosition(e);
            if (!currentPos) return;

            const dx = currentPos.x - dragStartPos.x;
            const dy = currentPos.y - dragStartPos.y;

            // 更新區域路徑
            const pathD = selectedArea.getAttribute('d');
            const newPathD = movePath(pathD, dx, dy);
            selectedArea.setAttribute('d', newPathD);

            // 更新遮罩
            const maskId = `mask-${selectedArea.id}`;
            const mask = document.querySelector(`#${maskId}`);
            if (mask) {
                mask.setAttribute('d', newPathD);
            }

            dragStartPos = currentPos;
        }

        // 停止拖曳
        function stopDragging() {
            isDragging = false;
            selectedArea = null;
            dragStartPos = null;
            saveAreas(); // 保存變更
        }

        // 切換區域面罩
        function toggleAreaMask(area, color) {
            const maskId = `mask-${area.id}`;
            const mask = document.querySelector(`#${maskId}`);
            if (mask) {
                mask.classList.remove('gray', 'red', 'blue', 'green');
                mask.classList.add(color); // 無論如何都會有一個顏色
            }

            // 更新面罩選擇和顏色指示器
            const areaItem = document.querySelector(`.area-item[data-area-id="${area.id}"]`);
            if (areaItem) {
                const select = areaItem.querySelector('.mask-select');
                const colorIndicator = areaItem.querySelector('.color-indicator');
                select.value = color;
                colorIndicator.className = `color-indicator ${color}`;
            }

            // 保存變更
            saveAreas();
        }

        // 編輯區域名稱
        function editAreaName(areaId) {
            const areaItem = document.querySelector(`.area-item[data-area-id="${areaId}"]`);
            if (!areaItem) return;

            const nameSpan = areaItem.querySelector('.area-name');
            const currentName = nameSpan.textContent;

            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.style.width = '100%';
            input.style.marginRight = '10px';
            input.style.padding = '2px 5px';
            input.style.border = '1px solid #ddd';
            input.style.borderRadius = '3px';

            // 替換名稱元素
            nameSpan.style.display = 'none';
            nameSpan.parentNode.insertBefore(input, nameSpan);
            input.focus();

            let isEditing = true;

            // 處理完成編輯
            function finishEdit() {
                if (!isEditing) return;
                isEditing = false;

                const newName = input.value.trim();
                if (newName) {
                    nameSpan.textContent = newName;
                    // 更新區域的 title 屬性
                    const area = document.getElementById(areaId);
                    if (area) {
                        area.setAttribute('title', newName);
                    }
                }
                nameSpan.style.display = '';
                if (input.parentNode) {
                    input.remove();
                }
                saveAreas(); // 保存變更
            }

            // 編輯完成事件
            input.addEventListener('blur', () => {
                setTimeout(finishEdit, 100); // 給予時間讓 keydown 事件先觸發
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    isEditing = false;
                    nameSpan.style.display = '';
                    if (input.parentNode) {
                        input.remove();
                    }
                }
            });
        }

        // 顯示命名對話框
        function showNameModal() {
            nameModal.style.display = 'flex';
            areaNameInput.value = '';
            areaNameInput.focus();
        }

        // 隱藏命名對話框
        function hideNameModal() {
            nameModal.style.display = 'none';
            areaNameInput.value = '';
        }

        // 取消區域命名
        function cancelAreaName() {
            if (tempArea) {
                tempArea.remove();
                tempArea = null;
            }
            hideNameModal();
            resetDrawingState();
        }

        // 確認區域命名
        function confirmAreaName() {
            const name = areaNameInput.value.trim() || `區域 ${Date.now()}`;
            const areaId = `area-${Date.now()}`;

            // 創建新區域
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', tempArea.getAttribute('d'));
            area.setAttribute('class', 'area');
            area.setAttribute('id', areaId);
            area.setAttribute('title', name);
            area.setAttribute('data-area-type', currentAreaType);

            // 添加到互動區域
            interactiveAreas.appendChild(area);

            // 創建遮罩，使用相同的路徑數據
            const mask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mask.setAttribute('id', `mask-${areaId}`);
            mask.setAttribute('d', tempArea.getAttribute('d'));
            mask.setAttribute('class', `area-mask gray`); // 預設為灰色
            
            // 添加遮罩到相應的組
            const maskGroup = overlaySvg.querySelector(`.mask-areas.${currentAreaType}`);
            if (maskGroup) {
                maskGroup.appendChild(mask);
            }

            // 創建列表項目
            const areaItem = document.createElement('div');
            areaItem.className = 'area-item';
            areaItem.setAttribute('data-area-id', areaId);
            areaItem.setAttribute('data-area-type', currentAreaType);
            areaItem.setAttribute('draggable', 'true');
            areaItem.innerHTML = `
                <span class="color-indicator none"></span>
                <span class="area-name" title="${name}">${name}</span>
                <select class="mask-select" onchange="toggleAreaMask(document.getElementById('${areaId}'), this.value)">
                    <option value="none">未施工</option>
                    <option value="blue">配線完成</option>
                    <option value="green">連線成功</option>
                </select>
                <button class="action-btn delete-btn" onclick="deleteArea('${areaId}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;

            // 添加區域項目到清單
            const contentId = currentAreaType === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
            const contentArea = document.getElementById(contentId);
            if (contentArea) {
                contentArea.appendChild(areaItem);
            }
            
            // 確保新添加的區域項目可見
            setTimeout(() => {
                // 獲取對應的內容區
                const contentId = currentAreaType === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
                const contentArea = document.getElementById(contentId);
                if (contentArea) {
                    contentArea.scrollTop = contentArea.scrollHeight;
                }
            }, 100);

            // 添加事件監聽器
            area.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                if (!isDrawing) {
                    startDragging(e, area);
                }
            });

            area.addEventListener('mousemove', function(e) {
                if (isDragging && selectedArea === area) {
                    dragArea(e);
                }
            });

            area.addEventListener('mouseup', function(e) {
                if (isDragging && selectedArea === area && e.button === 2) {
                    stopDragging();
                }
            });

            area.addEventListener('mouseleave', function() {
                if (isDragging && selectedArea === area) {
                    stopDragging();
                }
            });

            // 保存變更
            saveAreas();

            // 重新綁定拖放事件
            bindDragEventsToItems();

            // 重置狀態
            resetDrawingState();
            nameModal.style.display = 'none';
            areaNameInput.value = '';
            if (tempArea) {
                tempArea.remove();
                tempArea = null;
            }
        }

        // 保存區域資料
        function saveAreas() {
            const equipmentAreas = [];
            const electricalBoxAreas = [];
            
            // 分別獲取設備區域和電箱區域的列表（包含內容區中的項目）
            document.querySelectorAll('#equipmentList .area-item, #equipmentListContent .area-item').forEach(areaItem => {
                const areaId = areaItem.getAttribute('data-area-id');
                const area = document.getElementById(areaId);
                const mask = document.querySelector(`#mask-${areaId}`);
                
                if (area && areaItem) {
                    const name = areaItem.querySelector('.area-name').textContent;
                    const type = areaItem.getAttribute('data-area-type');
                    const pathD = area.getAttribute('d');
                    const status = areaItem.querySelector('.mask-select').value;

                    equipmentAreas.push({
                        id: areaId,
                        name: name,
                        type: type,
                        pathD: pathD,
                        status: status
                    });
                }
            });

            document.querySelectorAll('#electricalBoxList .area-item, #electricalBoxListContent .area-item').forEach(areaItem => {
                const areaId = areaItem.getAttribute('data-area-id');
                const area = document.getElementById(areaId);
                const mask = document.querySelector(`#mask-${areaId}`);
                
                if (area && areaItem) {
                    const name = areaItem.querySelector('.area-name').textContent;
                    const type = areaItem.getAttribute('data-area-type');
                    const pathD = area.getAttribute('d');
                    const status = areaItem.querySelector('.mask-select').value;

                    electricalBoxAreas.push({
                        id: areaId,
                        name: name,
                        type: type,
                        pathD: pathD,
                        status: status
                    });
                }
            });

            // 保存所有區域資料，包含順序
            localStorage.setItem('areas', JSON.stringify({
                equipment: equipmentAreas,
                electricalBox: electricalBoxAreas
            }));
        }

        // 載入區域資料
        function loadAreas() {
            const savedAreas = localStorage.getItem('areas');
            if (!savedAreas) return;

            try {
                const areasData = JSON.parse(savedAreas);
                const allAreas = {
                    equipment: areasData.equipment || [],
                    electricalBox: areasData.electricalBox || []
                };

                // 清除現有區域
                clearAreas();

                // 依類型載入區域
                Object.entries(allAreas).forEach(([type, areas]) => {
                    areas.forEach(areaData => {
                        if (!areaData || !areaData.id || !areaData.name || !areaData.type || !areaData.pathD) return;

                        // 創建區域
                        const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        area.setAttribute('d', areaData.pathD);
                        area.setAttribute('class', 'area');
                        area.setAttribute('id', areaData.id);
                        area.setAttribute('title', areaData.name);
                        area.setAttribute('data-area-type', areaData.type);

                        // 創建遮罩
                        if (areaData.status && areaData.status !== 'none') {
                            const mask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            mask.setAttribute('id', `mask-${areaData.id}`);
                            mask.setAttribute('d', areaData.pathD);
                            mask.setAttribute('class', `area-mask ${areaData.status}`);
                            const maskGroup = document.querySelector(`.mask-areas.${areaData.type}`);
                            if (maskGroup) {
                                maskGroup.appendChild(mask);
                            }
                        }

                        // 添加到互動區域
                        interactiveAreas.appendChild(area);

                        // 創建列表項目
                        const areaItem = document.createElement('div');
                        areaItem.className = 'area-item';
                        areaItem.setAttribute('data-area-id', areaData.id);
                        areaItem.setAttribute('data-area-type', areaData.type);
                        areaItem.setAttribute('draggable', 'true');
                        areaItem.innerHTML = `
                            <span class="color-indicator ${areaData.status}"></span>
                            <span class="area-name" title="${areaData.name}">${areaData.name}</span>
                            <select class="mask-select" onchange="toggleAreaMask(document.getElementById('${areaData.id}'), this.value)">
                                <option value="none" ${areaData.status === 'none' ? 'selected' : ''}>未施工</option>
                                <option value="blue" ${areaData.status === 'blue' ? 'selected' : ''}>配線完成</option>
                                <option value="green" ${areaData.status === 'green' ? 'selected' : ''}>連線成功</option>
                            </select>
                            <button class="action-btn delete-btn" onclick="deleteArea('${areaData.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        `;

                        // 添加區域項目到清單
                        const contentId = areaData.type === 'equipment' ? 'equipmentListContent' : 'electricalBoxListContent';
                        const contentArea = document.getElementById(contentId);
                        if (contentArea) {
                            contentArea.appendChild(areaItem);
                        }

                        // 添加事件監聽器
                        area.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            if (!isDrawing) {
                                startDragging(e, area);
                            }
                        });

                        area.addEventListener('mousemove', function(e) {
                            if (isDragging && selectedArea === area) {
                                dragArea(e);
                            }
                        });

                        area.addEventListener('mouseup', function(e) {
                            if (isDragging && selectedArea === area && e.button === 2) {
                                stopDragging();
                            }
                        });

                        area.addEventListener('mouseleave', function() {
                            if (isDragging && selectedArea === area) {
                                stopDragging();
                            }
                        });
                    });
                });
            } catch (error) {
                console.error('Error loading areas:', error);
            }
        }

        // 刪除區域
        function deleteArea(areaId) {
            const area = document.getElementById(areaId);
            const areaItem = document.querySelector(`.area-item[data-area-id="${areaId}"]`);
            const mask = document.querySelector(`#mask-${areaId}`);
            const areaType = area ? area.getAttribute('data-area-type') : null;

            if (area) area.remove();
            if (areaItem) areaItem.remove();
            if (mask) mask.remove();

            // 保存變更
            saveAreas();

            // 重置按鈕狀態
            if (isDrawing && currentAreaType === areaType) {
                isDrawing = false;
                currentAreaType = null;
                equipmentBtn.textContent = '新增設備區域';
                electricalBoxBtn.textContent = '新增電箱區域';
                overlaySvg.style.cursor = 'default';
            }
        }

        // 清除所有區域
        function clearAreas() {
            const existingAreas = document.querySelectorAll('.area');
            const existingMasks = document.querySelectorAll('.area-mask');
            const existingItems = document.querySelectorAll('.area-item');

            existingAreas.forEach(area => area.remove());
            existingMasks.forEach(mask => mask.remove());
            existingItems.forEach(item => item.remove());
        }

        // 初始化拖放功能
        function initDragAndDrop() {
            const lists = document.querySelectorAll('#equipmentListContent, #electricalBoxListContent');
            lists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                });

                list.addEventListener('drop', e => {
                    e.preventDefault();
                    const draggedItem = document.querySelector('.dragging');
                    if (!draggedItem) return;

                    // 計算最近的放置位置
                    const items = [...list.querySelectorAll('.area-item:not(.dragging)')];
                    let closestItem = null;
                    let closestOffset = Number.NEGATIVE_INFINITY;

                    items.forEach(item => {
                        const rect = item.getBoundingClientRect();
                        const offset = e.clientY - rect.top - rect.height / 2;

                        if (offset < 0 && offset > closestOffset) {
                            closestOffset = offset;
                            closestItem = item;
                        }
                    });

                    // 放置元素
                    if (closestItem) {
                        list.insertBefore(draggedItem, closestItem);
                    } else {
                        list.appendChild(draggedItem);
                    }

                    // 更新遮罩順序
                    const areaId = draggedItem.getAttribute('data-area-id');
                    updateMaskOrder(areaId);

                    // 保存更新後的順序
                    saveAreas();
                });
            });

            bindDragEventsToItems();
        }

        // 為區域項目添加拖放事件
        function bindDragEventsToItems() {
            document.querySelectorAll('.area-item').forEach(item => {
                item.setAttribute('draggable', 'true');
                
                item.addEventListener('dragstart', () => {
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
        }

        // 更新遮罩順序
        function updateMaskOrder(areaId) {
            const areaItem = document.querySelector(`.area-item[data-area-id="${areaId}"]`);
            if (!areaItem) return;

            const areaType = areaItem.getAttribute('data-area-type');
            const maskGroup = document.querySelector(`.mask-areas.${areaType}`);
            const mask = document.querySelector(`#mask-${areaId}`);
            
            if (mask && maskGroup) {
                const parentList = areaItem.parentElement;
                const items = [...parentList.querySelectorAll('.area-item')];
                const index = items.indexOf(areaItem);
                const masks = [...maskGroup.children];
                
                if (index >= 0) {
                    if (index < masks.length - 1) {
                        const nextMask = masks[index + 1];
                        maskGroup.insertBefore(mask, nextMask);
                    } else {
                        maskGroup.appendChild(mask);
                    }
                }
            }
        }

        // 開始拖動
        function handleDragStart(e) {
            const item = e.target.closest('.area-item');
            if (!item) return;

            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', item.getAttribute('data-area-id'));

            // 設定拖動時的視覺效果
            requestAnimationFrame(() => {
                item.style.opacity = '0.5';
            });
        }

        let dropTarget = null;

        // 拖動經過
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const list = e.currentTarget;
            const draggingItem = document.querySelector('.dragging');
            if (!draggingItem) return;

            const items = [...list.querySelectorAll('.area-item:not(.dragging)')];
            let afterElement = null;

            for (let i = 0; i < items.length; i++) {
                const box = items[i].getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                if (offset < 0) {
                    afterElement = items[i];
                    break;
                }
            }

            // 移除所有現有的放置指示器
            document.querySelectorAll('.drop-position').forEach(el => el.remove());

            // 創建新的放置指示器
            const dropPosition = document.createElement('div');
            dropPosition.className = 'drop-position';

            if (afterElement) {
                list.insertBefore(dropPosition, afterElement);
            } else {
                list.appendChild(dropPosition);
            }

            // 更新全局的 dropTarget
            dropTarget = afterElement;
        }

        // 結束拖動
        function handleDragEnd(e) {
            const item = e.target.closest('.area-item');
            if (item) {
                item.classList.remove('dragging');
                item.style.opacity = '';
            }

            // 移除所有放置位置指示器
            document.querySelectorAll('.drop-position').forEach(el => el.remove());
        }

        // 放下元素
        function handleDrop(e) {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedItem = document.querySelector(`.area-item[data-area-id="${draggedId}"]`);
            if (!draggedItem) return;

            const list = e.currentTarget;
            const items = [...list.querySelectorAll('.area-item:not(.dragging)')];
            let afterElement = null;

            // 確定放置位置
            for (let i = 0; i < items.length; i++) {
                const box = items[i].getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                if (offset < 0) {
                    afterElement = items[i];
                    break;
                }
            }

            // 移除拖動樣式
            draggedItem.classList.remove('dragging');
            draggedItem.style.opacity = '';

            // 放置元素
            if (afterElement) {
                list.insertBefore(draggedItem, afterElement);
            } else {
                list.appendChild(draggedItem);
            }

            // 更新遮罩順序
            const areaType = draggedItem.getAttribute('data-area-type');
            const maskGroup = document.querySelector(`.mask-areas.${areaType}`);
            const mask = document.querySelector(`#mask-${draggedId}`);
            
            if (mask && maskGroup) {
                const allItems = [...list.querySelectorAll('.area-item')];
                const index = allItems.indexOf(draggedItem);
                const masks = [...maskGroup.children];
                
                if (index >= 0) {
                    if (index < masks.length - 1) {
                        const nextMask = masks[index + 1];
                        maskGroup.insertBefore(mask, nextMask);
                    } else {
                        maskGroup.appendChild(mask);
                    }
                }
            }

            // 移除所有放置指示器
            document.querySelectorAll('.drop-position').forEach(el => el.remove());

            // 重新綁定拖放事件
            bindDragEventsToItems();

            // 保存更新後的順序
            saveAreas();
        }

        // 初始化拖放功能
        function initDragAndDrop() {
            const lists = document.querySelectorAll('#equipmentListContent, #electricalBoxListContent');
            lists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                });

                list.addEventListener('drop', e => {
                    e.preventDefault();
                    const draggedItem = document.querySelector('.dragging');
                    if (!draggedItem) return;

                    // 計算最近的放置位置
                    const items = [...list.querySelectorAll('.area-item:not(.dragging)')];
                    let closestItem = null;
                    let closestOffset = Number.NEGATIVE_INFINITY;

                    items.forEach(item => {
                        const rect = item.getBoundingClientRect();
                        const offset = e.clientY - rect.top - rect.height / 2;

                        if (offset < 0 && offset > closestOffset) {
                            closestOffset = offset;
                            closestItem = item;
                        }
                    });

                    // 放置元素
                    if (closestItem) {
                        list.insertBefore(draggedItem, closestItem);
                    } else {
                        list.appendChild(draggedItem);
                    }

                    // 更新遮罩順序
                    const areaId = draggedItem.getAttribute('data-area-id');
                    const areaType = draggedItem.getAttribute('data-area-type');
                    const maskGroup = document.querySelector(`.mask-areas.${areaType}`);
                    const mask = document.querySelector(`#mask-${areaId}`);
                    
                    if (mask && maskGroup) {
                        const parentList = draggedItem.parentElement;
                        const items = [...parentList.querySelectorAll('.area-item')];
                        const index = items.indexOf(draggedItem);
                        const masks = [...maskGroup.children];
                        
                        if (index >= 0) {
                            if (index < masks.length - 1) {
                                const nextMask = masks[index + 1];
                                maskGroup.insertBefore(mask, nextMask);
                            } else {
                                maskGroup.appendChild(mask);
                            }
                        }
                    }

                    // 保存更新後的順序
                    saveAreas();
                });
            });

            bindDragEventsToItems();
        }

        // 為區域項目添加拖放事件
        function bindDragEventsToItems() {
            document.querySelectorAll('.area-item').forEach(item => {
                item.setAttribute('draggable', 'true');
                
                item.addEventListener('dragstart', () => {
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
        }

        // 切換區域狀態
        function toggleAreaMask(area, status) {
            if (!area) return;
            
            // 更新區域狀態
            area.setAttribute('data-status', status);
            
            // 更新選單狀態
            const areaId = area.id;
            const areaItem = document.querySelector(`.area-item[data-area-id="${areaId}"]`);
            if (areaItem) {
                const colorIndicator = areaItem.querySelector('.color-indicator');
                if (colorIndicator) {
                    colorIndicator.className = `color-indicator ${status}`;
                }

                // 更新選單選項
                const select = areaItem.querySelector('.mask-select');
                if (select) {
                    select.value = status;
                }
            }

            // 更新遮罩
            const mask = document.querySelector(`#mask-${areaId}`);
            if (mask) {
                mask.setAttribute('data-status', status);
                const colors = {
                    'none': '#999',
                    'blue': '#2196F3',
                    'green': '#4CAF50'
                };
                mask.style.fill = colors[status] || '#999';
                mask.style.fillOpacity = '0.5';
            } else {
                // 如果遮罩不存在，創建一個新的
                const maskGroup = document.querySelector(`.mask-areas.${area.getAttribute('data-area-type')}`);
                if (maskGroup) {
                    const newMask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    newMask.setAttribute('id', `mask-${areaId}`);
                    newMask.setAttribute('d', area.getAttribute('d'));
                    newMask.setAttribute('data-status', status);
                    const colors = {
                        'none': '#999',
                        'blue': '#2196F3',
                        'green': '#4CAF50'
                    };
                    newMask.style.fill = colors[status] || '#999';
                    newMask.style.fillOpacity = '0.5';
                    maskGroup.appendChild(newMask);
                }
            }
            
            // 保存狀態
            saveAreas();
        }

// 保存區域狀態
function saveAreas() {
    const equipmentAreas = [];
    const electricalBoxAreas = [];
    
    // 收集設備區域
    document.querySelectorAll('#equipmentList .area-item').forEach(areaItem => {
        const areaId = areaItem.getAttribute('data-area-id');
        const area = document.getElementById(areaId);
        if (area && areaItem) {
            const areaData = {
                id: areaId,
                name: areaItem.querySelector('.area-name').textContent || `區域 ${areaId}`,
                type: 'equipment',
                status: area.getAttribute('data-status') || 'none',
                d: area.getAttribute('d')  // 使用 'd' 而不是 'path'
            };
            if (areaData.d) {  // 確保有路徑數據
                equipmentAreas.push(areaData);
            }
        }
    });
    
    // 收集電箱區域
    document.querySelectorAll('#electricalBoxList .area-item').forEach(areaItem => {
        const areaId = areaItem.getAttribute('data-area-id');
        const area = document.getElementById(areaId);
        if (area && areaItem) {
            const areaData = {
                id: areaId,
                name: areaItem.querySelector('.area-name').textContent || `區域 ${areaId}`,
                type: 'electrical-box',
                status: area.getAttribute('data-status') || 'none',
                d: area.getAttribute('d')  // 使用 'd' 而不是 'path'
            };
            if (areaData.d) {  // 確保有路徑數據
                electricalBoxAreas.push(areaData);
            }
        }
    });
    
    // 準備要儲存的資料
    const areasData = {
        equipment: equipmentAreas,
        'electrical-box': electricalBoxAreas,
        lastUpdated: new Date().toISOString()
    };

    // 保存到 localStorage
    localStorage.setItem('areas', JSON.stringify(areasData));

    // 保存到檔案
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/save-areas', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                console.log('資料已成功儲存到檔案');
            } else {
                console.error('儲存資料到檔案時發生錯誤');
            }
        }
    };
    xhr.send(JSON.stringify(areasData));
}

// 檢查區域列表結構
function checkAreaListStructure() {
    // 檢查設備區域列表
    const equipmentList = document.getElementById('equipmentList');
    if (!equipmentList) {
        console.error('Equipment list not found!');
    } else {
        console.log('Equipment list found:', equipmentList);
    }
    
    // 檢查電箱區域列表
    const electricalBoxList = document.getElementById('electricalBoxList');
    if (!electricalBoxList) {
        console.error('Electrical box list not found!');
        
        // 如果找不到電箱區域列表，嘗試創建它
        const sidePanel = document.getElementById('sidePanel');
        if (sidePanel) {
            console.log('Creating missing electrical box list');
            const newList = document.createElement('div');
            newList.id = 'electricalBoxList';
            newList.className = 'area-list';
            
            const header = document.createElement('div');
            header.className = 'area-list-header';
            
            const title = document.createElement('h3');
            title.textContent = '電箱區域';
            header.appendChild(title);
            
            const button = document.createElement('button');
            button.className = 'mask-btn';
            button.id = 'electricalBoxBtn';
            button.setAttribute('onclick', "toggleDrawMode('electrical-box', this)");
            button.textContent = '新增電箱區域';
            header.appendChild(button);
            
            newList.appendChild(header);
            sidePanel.appendChild(newList);
            
            console.log('Created electrical box list:', newList);
        }
    } else {
        console.log('Electrical box list found:', electricalBoxList);
    }
}

// 載入區域
function loadAreas() {
    // 檢查區域列表結構
    checkAreaListStructure();
    
    const savedAreas = localStorage.getItem('areas');
    if (!savedAreas) return;
    
    try {
        // 清除現有區域
        document.querySelectorAll('.area').forEach(area => area.remove());
        document.querySelectorAll('.mask-areas path').forEach(mask => mask.remove());
        document.querySelectorAll('.area-item').forEach(item => item.remove());
        
        const areasData = JSON.parse(savedAreas);
        console.log('Loaded areas data:', areasData);
        
        // 檢查是否為新格式（包含分類）
        if (areasData.equipment || areasData['electrical-box'] || areasData.electricalBox) {
            // 處理設備區域
            if (areasData.equipment && Array.isArray(areasData.equipment)) {
                console.log('Loading equipment areas:', areasData.equipment.length);
                areasData.equipment.forEach(areaData => loadAreaItem(areaData, 'equipment'));
            }
            
            // 處理電箱區域 - 新格式
            if (areasData['electrical-box'] && Array.isArray(areasData['electrical-box'])) {
                console.log('Loading electrical-box areas:', areasData['electrical-box'].length);
                if (areasData['electrical-box'].length > 0) {
                    console.log('Sample electrical-box data:', areasData['electrical-box'][0]);
                }
                areasData['electrical-box'].forEach(areaData => {
                    // 確保電箱區域的類型正確
                    areaData.type = 'electrical-box';
                    loadAreaItem(areaData, 'electrical-box');
                });
            }
            
            // 處理電箱區域 - 密容舊格式
            if (areasData.electricalBox && Array.isArray(areasData.electricalBox)) {
                console.log('Loading electricalBox areas (old format):', areasData.electricalBox.length);
                areasData.electricalBox.forEach(areaData => {
                    // 確保電箱區域的類型正確
                    areaData.type = 'electrical-box';
                    loadAreaItem(areaData, 'electrical-box');
                });
            }
        } else if (Array.isArray(areasData)) {
            // 密容舊格式（單一陣列）
            console.log('Loading areas from old array format:', areasData.length);
            areasData.forEach(areaData => loadAreaItem(areaData, areaData.type));
        }
        
        // 強制重新渲染電箱區域的下拉選單
        setTimeout(() => {
            forceRenderSelects();
            
            // 檢查電箱區域是否正確載入
            const electricalBoxItems = document.querySelectorAll('#electricalBoxList .area-item');
            console.log('Electrical box items loaded:', electricalBoxItems.length);
            electricalBoxItems.forEach(item => {
                const select = item.querySelector('.mask-select');
                console.log('Select element found:', !!select);
                if (select) {
                    console.log('Select options:', select.options.length);
                }
            });
        }, 500);
        
        // 重新綁定拖放事件
        initDragAndDrop();
    } catch (error) {
        console.error('Error loading areas:', error);
    }
}

// 強制重新渲染下拉選單
function forceRenderSelects() {
    console.log('Force rendering select elements for electrical box areas');
    // 對所有電箱區域的下拉選單進行重新渲染
    const electricalBoxItems = document.querySelectorAll('#electricalBoxList .area-item');
    console.log('Found electrical box items for rendering:', electricalBoxItems.length);
    
    electricalBoxItems.forEach(item => {
        const areaId = item.getAttribute('data-area-id');
        const area = document.getElementById(areaId);
        if (!area) return;
        
        const status = area.getAttribute('data-status') || 'none';
        const contentDiv = item.querySelector('.area-item-content');
        if (!contentDiv) return;
        
        // 移除舊的下拉選單
        const oldSelect = item.querySelector('.mask-select');
        if (oldSelect) {
            oldSelect.remove();
        }
        
        // 創建新的下拉選單
        const select = document.createElement('select');
        select.className = 'mask-select';
        select.title = '區域狀態';
        select.setAttribute('aria-label', '區域狀態');
        select.setAttribute('onchange', `toggleAreaMask(document.getElementById('${areaId}'), this.value)`);
        
        // 添加選項
        const option1 = document.createElement('option');
        option1.value = 'none';
        option1.textContent = '未施工';
        if (status === 'none') option1.selected = true;
        select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = 'blue';
        option2.textContent = '配線完成';
        if (status === 'blue') option2.selected = true;
        select.appendChild(option2);
        
        const option3 = document.createElement('option');
        option3.value = 'green';
        option3.textContent = '連線成功';
        if (status === 'green') option3.selected = true;
        select.appendChild(option3);
        
        // 將新的下拉選單插入到正確的位置
        const deleteBtn = contentDiv.querySelector('.delete-btn');
        if (deleteBtn) {
            contentDiv.insertBefore(select, deleteBtn);
        } else {
            contentDiv.appendChild(select);
        }
        
        console.log('Forced render select for area:', areaId, 'options:', select.options.length);
    });
}

// 載入單個區域項目的輔助函數
function loadAreaItem(areaData, type) {
    console.log('Loading area item:', areaData, 'type:', type);
    // 確保type有值
    const areaType = areaData.type || type;
    if (!areaType) {
        console.error('No area type found for:', areaData);
        return;
    }
    
    // 將區域類型轉換為對應的列表ID格式
    const areaListId = areaType === 'electrical-box' ? 'electricalBoxList' : `${areaType}List`;
    
    // 確保區域有ID
    if (!areaData.id) {
        areaData.id = Date.now().toString();
        console.log('Generated new ID for area:', areaData.id);
    }
    
    // 創建區域
    const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    area.setAttribute('id', areaData.id);
    area.setAttribute('class', 'area');
    area.setAttribute('d', areaData.d || areaData.path);  // 兼容舊版數據
    area.setAttribute('data-area-type', areaType);
    area.setAttribute('data-status', areaData.status || 'none');
    document.querySelector('.interactive-areas').appendChild(area);
    console.log('Created area element with ID:', areaData.id);

    // 創建遮罩
    const maskGroup = document.querySelector(`.mask-areas.${areaType}`);
    if (maskGroup) {
        const mask = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        mask.setAttribute('id', `mask-${areaData.id}`);
        mask.setAttribute('d', areaData.d || areaData.path);  // 兼容舊版數據
        mask.setAttribute('data-status', areaData.status || 'none');
        const colors = {
            'none': '#999',
            'blue': '#2196F3',
            'green': '#4CAF50'
        };
        mask.style.fill = colors[areaData.status || 'none'] || '#999';
        mask.style.fillOpacity = '0.5';
        maskGroup.appendChild(mask);
        console.log('Created mask for area:', areaData.id);
    } else {
        console.error('Mask group not found for area type:', areaType);
    }
    
    // 確保區域名稱存在
    if (!areaData.name) {
        areaData.name = `區域 ${areaData.id}`;
        console.log('Generated default name for area:', areaData.name);
    }

    // 創建區域項目
    const areaList = document.getElementById(areaListId);
    console.log(`Looking for area list with ID: ${areaListId}, found:`, !!areaList);
    
    if (areaList) {
        const areaItem = document.createElement('div');
        areaItem.classList.add('area-item');
        areaItem.setAttribute('data-area-id', areaData.id);
        areaItem.setAttribute('data-area-type', areaType);
        areaItem.setAttribute('draggable', 'true');
        console.log('Created area item element for:', areaData.id);
        
        // 創建區域內容容器
        const contentDiv = document.createElement('div');
        contentDiv.className = 'area-item-content';
        
        // 添加狀態圓圈
        const statusCircle = document.createElement('span');
        statusCircle.className = `status-circle ${areaData.status || 'none'}`;
        contentDiv.appendChild(statusCircle);
        console.log('Added status circle for area:', areaData.id);
        
        // 添加區域名稱
        const nameSpan = document.createElement('span');
        nameSpan.className = 'area-name';
        nameSpan.textContent = areaData.name || `區域 ${areaData.id}`;
        contentDiv.appendChild(nameSpan);
        console.log('Added name span for area:', areaData.id, 'with text:', nameSpan.textContent);
        
        // 添加下拉選單
        const select = document.createElement('select');
        select.className = 'mask-select';
        select.title = '區域狀態';
        select.setAttribute('aria-label', '區域狀態');
        select.setAttribute('onchange', `toggleAreaMask(document.getElementById('${areaData.id}'), this.value)`);
        console.log('Created select element for area:', areaData.id);
        
        // 添加選項
        const option1 = document.createElement('option');
        option1.value = 'none';
        option1.textContent = '未施工';
        if (areaData.status === 'none' || !areaData.status) option1.selected = true;
        select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = 'blue';
        option2.textContent = '配線完成';
        if (areaData.status === 'blue') option2.selected = true;
        select.appendChild(option2);
        
        const option3 = document.createElement('option');
        option3.value = 'green';
        option3.textContent = '連線成功';
        if (areaData.status === 'green') option3.selected = true;
        select.appendChild(option3);
        console.log('Added options to select for area:', areaData.id, 'option count:', select.options.length);
        
        contentDiv.appendChild(select);
        console.log('Appended select to content div for area:', areaData.id);
        
        // 添加刪除按鈕
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn delete-btn';
        deleteBtn.setAttribute('onclick', `deleteArea('${areaData.id}')`);
        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
        contentDiv.appendChild(deleteBtn);
        console.log('Added delete button for area:', areaData.id);
        
        // 將內容容器添加到區域項目
        areaItem.appendChild(contentDiv);
        console.log('Appended content div to area item for:', areaData.id);
        
        // 找到對應的內容區並添加區域項目
        const contentAreaId = areaType === 'electrical-box' ? 'electricalBoxListContent' : `${areaType}ListContent`;
        const contentArea = document.getElementById(contentAreaId);
        if (contentArea) {
            contentArea.appendChild(areaItem);
            console.log('Appended area item to content area:', contentAreaId, 'for area:', areaData.id, 'area type:', areaType);
        } else {
            // 如果找不到內容區，則添加到列表根元素（向後兼容）
            areaList.appendChild(areaItem);
            console.log('Content area not found, appended to list root for:', areaData.id, 'area type:', areaType);
        }
        
        // 檢查元素是否已正確添加到DOM
        setTimeout(() => {
            const addedItem = document.querySelector(`[data-area-id="${areaData.id}"]`);
            console.log('Verified area item in DOM:', !!addedItem);
            if (addedItem) {
                const addedSelect = addedItem.querySelector('.mask-select');
                console.log('Verified select in DOM:', !!addedSelect, 'options:', addedSelect ? addedSelect.options.length : 0);
            }
        }, 0);
    } else {
        console.error(`Area list not found for type: ${areaType}`);
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 顯示訪問碼輸入視窗
    showAccessModal();
});
    </script>
</body>
</html>
